<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Agrima Mart</title>

<script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#fff}
header{background:#25D366;color:#fff;padding:14px;font-size:18px}
#products{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;padding:12px}
.product{border:1px solid #ddd;border-radius:10px;padding:8px;cursor:pointer}
.product img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:8px}
.price{color:#2e7d32;font-weight:bold}

#modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#0008}
.modalBox{background:#fff;height:100%;overflow:auto;padding:14px}

.gallery{display:flex;gap:10px;overflow-x:auto}
.gallery img{width:100%;max-width:400px;border-radius:10px}

.variant{margin:12px 0}
.variantTitle{font-weight:bold;margin-bottom:6px}

.sizeBtn{
  padding:6px 12px;border:1px solid #25D366;
  background:#fff;border-radius:6px;margin-right:6px
}
.sizeBtn.active{background:#25D366;color:#fff}
.sizeBtn.disabled{opacity:.4;pointer-events:none}

.colorRow{display:flex;gap:10px}
.colorDot{
  width:26px;height:26px;border-radius:50%;
  border:2px solid #ccc;cursor:pointer
}
.colorDot.active{border:3px solid #25D366}
.colorDot.disabled{opacity:.3;pointer-events:none}

#cartBtn{
  position:fixed;bottom:20px;right:20px;
  background:#25D366;color:#fff;
  width:60px;height:60px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:24px
}
#cartCount{
  position:absolute;top:-6px;right:-6px;
  background:red;color:#fff;border-radius:50%;
  padding:4px 7px;font-size:12px
}

#toast{
  position:fixed;bottom:30px;left:50%;
  transform:translateX(-50%);
  background:#333;color:#fff;
  padding:10px 18px;border-radius:20px;display:none
}
</style>
</head>

<body>

<header>Agrima Mart</header>
<div id="products"></div>

<div id="cartBtn">ðŸ›’<span id="cartCount">0</span></div>
<div id="modal"></div>
<div id="toast"></div>

<script>
const sheetURL = "https://opensheet.elk.sh/1DLJoLnM_GcB_a1uYDOk1YaFX3KTHEXCAF4gxgUXWdE4/Sheet1";
const phone = "919929333794";

let products=[], cart=JSON.parse(localStorage.getItem("cart"))||{};
let selectedSize=null, selectedColor=null;

const productsDiv=document.getElementById("products");
const modal=document.getElementById("modal");

function toast(t){
  document.getElementById("toast").innerText=t;
  document.getElementById("toast").style.display="block";
  setTimeout(()=>toastBox.style.display="none",2000);
}

function parseStock(s){
  let m={}; if(!s) return m;
  s.split("|").forEach(x=>{
    let [k,v]=x.split(":"); m[k]=+v;
  });
  return m;
}

function parseColorImages(s){
  let m={}; if(!s) return m;
  s.split("|").forEach(x=>{
    let [c,imgs]=x.split("=");
    if(c && imgs) m[c]=imgs.split("|");
  });
  return m;
}

function colorHex(c){
  return {
    blue:"#1e88e5",black:"#000",
    red:"#e53935",green:"#43a047",
    white:"#fff"
  }[c.toLowerCase()]||"#999";
}

fetch(sheetURL).then(r=>r.json()).then(d=>{
products=d.map(p=>({
  name:p.name,
  price:+p.offer||+p.mrp,
  mrp:+p.mrp,
  desc:p.description||"",
  imgs:p.images.split("|"),
  sizes:p.sizes?p.sizes.split("|"):[],
  colors:p.colors?p.colors.split("|"):[],
  stock:p.stock||"",
  colorImgs:p.color_images||""
}));
render();
});

function render(){
productsDiv.innerHTML=products.map(p=>`
<div class="product" onclick="openProduct('${p.name}')">
<img src="${p.imgs[0]}">
<h4>${p.name}</h4>
<p class="price">â‚¹${p.price}</p>
</div>`).join("");
updateCount();
}

function openProduct(name){
const p=products.find(x=>x.name===name);
selectedSize=null; selectedColor=null;

const stock=parseStock(p.stock);
const colorImgs=parseColorImages(p.colorImgs);

modal.innerHTML=`
<div class="modalBox">
<button onclick="modal.style.display='none'">â¬… Back</button>

<div class="gallery" id="gallery">
${p.imgs.map(i=>`<img src="${i}">`).join("")}
</div>

<h3>${p.name}</h3>
<p>${p.desc}</p>

${p.sizes.length?`
<div class="variant">
<div class="variantTitle">Size</div>
${p.sizes.map(s=>{
const dis=p.colors.length
? p.colors.every(c=>(stock[`${s}-${c}`]||0)<=0)
: (stock[s]||0)<=0;
return `<button class="sizeBtn ${dis?'disabled':''}"
onclick="selectSize('${s}')">${s}</button>`;
}).join("")}
</div>`:""}

${p.colors.length?`
<div class="variant">
<div class="variantTitle">Color</div>
<div class="colorRow">
${p.colors.map(c=>{
const dis=selectedSize?(stock[`${selectedSize}-${c}`]||0)<=0:true;
return `<div class="colorDot ${dis?'disabled':''}"
style="background:${colorHex(c)}"
onclick="selectColor('${c}','${p.name}')"></div>`;
}).join("")}
</div></div>`:""}

<button style="width:100%;padding:14px;background:#25D366;color:#fff;border:none;border-radius:6px"
onclick="addToCart('${p.name}')">Add to Cart</button>
</div>`;
modal.style.display="block";
}

function selectSize(s){selectedSize=s}

function selectColor(c,name){
selectedColor=c;
const p=products.find(x=>x.name===name);
const map=parseColorImages(p.colorImgs);
const imgs=map[c]||p.imgs;
document.getElementById("gallery").innerHTML=imgs.map(i=>`<img src="${i}">`).join("");
}

function addToCart(name){
const p=products.find(x=>x.name===name);
if(p.sizes.length&&!selectedSize){alert("Select size");return;}
if(p.colors.length&&!selectedColor){alert("Select color");return;}

const key=`${name} (${selectedSize||""}${selectedColor?", "+selectedColor:""})`;
cart[key]=(cart[key]||0)+1;
localStorage.setItem("cart",JSON.stringify(cart));
updateCount();
alert("Added to cart");
}

function updateCount(){
document.getElementById("cartCount").innerText=
Object.values(cart).reduce((a,b)=>a+b,0);
}
</script>
</body>
</html>
