<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Agrima Mart</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#25D366">

<style>
body{margin:0;font-family:Arial}
header{background:#25D366;color:#fff;padding:14px;text-align:center;font-size:18px;position:sticky;top:0;z-index:10}

#products{display:grid;gap:12px;padding:12px}
@media(max-width:600px){#products{grid-template-columns:repeat(2,1fr)}}
@media(min-width:601px){#products{grid-template-columns:repeat(5,1fr)}}

.product{border:1px solid #ddd;border-radius:10px;padding:8px}
.product img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:8px}

.price{color:#2e7d32;font-weight:bold}
del{color:#888;font-size:12px}

.cardQty{display:flex;gap:10px;align-items:center}
.cardQty button{padding:6px 12px;border:none;background:#25D366;border-radius:6px}

#cartBtn{
position:fixed;bottom:22px;right:22px;background:#25D366;
width:64px;height:64px;border-radius:50%;
display:flex;align-items:center;justify-content:center;
font-size:28px;z-index:200
}
#cartCount{
position:absolute;top:-6px;right:-6px;background:red;
color:#fff;border-radius:50%;padding:4px 8px;font-size:13px
}

#installBtn{
display:none;position:fixed;bottom:100px;right:22px;
padding:12px 16px;background:#25D366;color:#fff;
border:none;border-radius:30px;z-index:300
}

#cartModal{
display:none;position:fixed;top:0;left:0;
width:100%;height:100%;background:rgba(0,0,0,.5);z-index:999
}
.modalBox{
background:#fff;width:100%;height:100%;
overflow-y:auto;padding:14px;box-sizing:border-box
}

.cartItem{
display:flex;align-items:center;gap:10px;
border-bottom:1px solid #ddd;padding:8px 0
}
.cartItem img{
width:48px;height:48px;object-fit:cover;border-radius:6px
}
</style>
</head>

<body>

<header>Agrima Mart</header>

<div id="products"></div>

<div id="cartBtn" onclick="openCart()">ðŸ›’<span id="cartCount">0</span></div>
<button id="installBtn">Install App</button>
<div id="cartModal"></div>

<script>
const phone="919929333794";
const sheetURL="https://opensheet.elk.sh/1DLJoLnM_GcB_a1uYDOk1YaFX3KTHEXCAF4gxgUXWdE4/Sheet1";

let products=[], cart={};
const productsDiv=document.getElementById("products");
const cartModal=document.getElementById("cartModal");
const installBtn=document.getElementById("installBtn");

/* ---------- LOAD PRODUCTS FIRST ---------- */
fetch(sheetURL).then(r=>r.json()).then(d=>{
products=d.map(p=>({
name:p.name,
price:+p.offer||+p.mrp,
mrp:+p.mrp,
imgs:p.images.split("|")
}));
init();
});

/* ---------- CRITICAL FIX ---------- */
function init(){
const param=new URLSearchParams(location.search).get("order");

/* IF CART LINK EXISTS â†’ DO NOT RENDER HOME PAGE */
if(param){
try{
cart=JSON.parse(atob(param));
openCart(true);   // force frozen cart
updateCount();
return;           // STOP HERE (very important)
}catch(e){}
}

/* NORMAL FLOW */
cart=JSON.parse(localStorage.getItem("cart"))||{};
renderProducts();
}

/* ---------- HOME ---------- */
function renderProducts(){
productsDiv.innerHTML=products.map(p=>{
let q=cart[p.name]||0;
return`
<div class="product">
<img src="${p.imgs[0]}" loading="lazy">
<h4>${p.name}</h4>
<p class="price">â‚¹${p.price} <del>â‚¹${p.mrp}</del></p>
<div class="cardQty">
<button onclick="updateCart('${p.name}',-1)">âˆ’</button>
<span>${q}</span>
<button onclick="updateCart('${p.name}',1)">+</button>
</div>
</div>`;
}).join("");
updateCount();
}

/* ---------- CART ---------- */
function updateCart(n,v){
cart[n]=(cart[n]||0)+v;
if(cart[n]<=0) delete cart[n];
localStorage.setItem("cart",JSON.stringify(cart));
renderProducts();
}

function updateCount(){
cartCount.innerText=Object.values(cart).reduce((a,b)=>a+b,0);
}

function openCart(frozen=false){
let total=0;
cartModal.innerHTML=`
<div class="modalBox">
<h3>Your Cart</h3>
${Object.keys(cart).map(n=>{
let p=products.find(x=>x.name===n);
let t=p.price*cart[n]; total+=t;
return`
<div class="cartItem">
<img src="${p.imgs[0]}" loading="lazy">
<div style="flex:1">
<b>${n}</b><br>â‚¹${p.price}
${frozen?"":`
<div class="cardQty">
<button onclick="updateCart('${n}',-1)">âˆ’</button>
<span>${cart[n]}</span>
<button onclick="updateCart('${n}',1)">+</button>
</div>`}
</div>
<b>â‚¹${t}</b>
</div>`}).join("")}
<hr>
<h3>Total â‚¹${total}</h3>
${frozen?"":"<button onclick='checkout()'>Place Order</button>"}
</div>`;
cartModal.style.display="block";
}

/* ---------- CHECKOUT ---------- */
function checkout(){
const encoded=btoa(JSON.stringify(cart));
let msg="Order from Agrima Mart%0A";
let total=0;
for(let n in cart){
let p=products.find(x=>x.name===n);
let t=p.price*cart[n]; total+=t;
msg+=`${n} x ${cart[n]} = â‚¹${t}%0A`;
}
const link=location.origin+location.pathname+"?order="+encoded;
msg+=`%0ATotal â‚¹${total}%0A${link}`;
window.open(`https://wa.me/${phone}?text=${msg}`);
cart={};
localStorage.removeItem("cart");
updateCount();
cartModal.style.display="none";
}

/* ---------- INSTALL ---------- */
let dp;
window.addEventListener("beforeinstallprompt",e=>{
e.preventDefault(); dp=e;
if(!window.matchMedia('(display-mode: standalone)').matches)
installBtn.style.display="block";
});
installBtn.onclick=()=>{installBtn.style.display="none";dp.prompt();};

if("serviceWorker" in navigator){
navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
