<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AGRIMA MART</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#25D366">
<script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#fff}
#topHeader{background:#25D366;color:#fff;padding:10px 14px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:20}
.title{font-size:18px;font-weight:bold}
.headerSocial{display:flex;gap:10px}
.headerSocial img{width:26px;height:26px;border-radius:50%}

#search{width:94%;margin:10px auto;padding:10px;display:block}
#categoryBar{display:flex;overflow-x:auto;padding:8px;background:#eee}
#categoryBar button{margin-right:8px;border:none;border-radius:20px;padding:8px 14px}
#categoryBar .active{background:#25D366;color:#fff}

#products{display:grid;gap:12px;padding:12px}
@media(max-width:600px){#products{grid-template-columns:repeat(2,1fr)}}
@media(min-width:601px){#products{grid-template-columns:repeat(5,1fr)}}

.product{border:1px solid #ddd;border-radius:10px;padding:8px}
.product img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:8px}
.price{color:#2e7d32;font-weight:bold}

.qty{display:flex;gap:12px;justify-content:center;margin-top:6px}
.qty button{padding:6px 14px;border:none;background:#25D366;color:#fff;border-radius:6px}

#cartBtn{position:fixed;bottom:22px;right:22px;width:64px;height:64px;border-radius:50%;background:#25D366;color:#fff;display:flex;align-items:center;justify-content:center;font-size:26px;z-index:200}
#cartCount{position:absolute;top:-6px;right:-6px;background:red;color:#fff;border-radius:50%;padding:4px 8px;font-size:13px}

#modal,#cartModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:999}
.modalBox{background:#fff;height:100%;overflow:auto;padding:14px}

.colors{display:flex;gap:8px;margin:10px 0}
.color{width:24px;height:24px;border-radius:50%;border:2px solid #ccc}
.color.active{border:3px solid #000}
.sizes{display:flex;gap:8px;margin:10px 0;flex-wrap:wrap}
.size{padding:6px 12px;border:1px solid #888;border-radius:6px}
.size.active{background:#25D366;color:#fff;border:none}

.cartItem{display:flex;gap:10px;border-bottom:1px solid #ddd;padding:8px 0}
.cartItem img{width:50px;height:50px;border-radius:6px}

#installBtn{position:fixed;bottom:100px;right:22px;padding:14px 18px;border-radius:30px;background:#000;color:#fff;border:none;display:none;z-index:300}
#toast{position:fixed;bottom:40px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:10px 18px;border-radius:20px;display:none;z-index:9999}
</style>
</head>

<body>

<header id="topHeader">
<span class="title">AGRIMA MART</span>
<div class="headerSocial">
<a href="https://wa.me/919929333794"><img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg"></a>
<a href="https://instagram.com/agrima.mart"><img src="https://upload.wikimedia.org/wikipedia/commons/a/a5/Instagram_icon.png"></a>
<a href="https://facebook.com/p/Agrima-Mart-61575460105163/"><img src="https://upload.wikimedia.org/wikipedia/commons/1/1b/Facebook_icon.svg"></a>
</div>
</header>

<input id="search" placeholder="Search products...">
<div id="categoryBar"></div>
<div id="products"></div>

<div id="cartBtn" onclick="openCart()">ðŸ›’<span id="cartCount">0</span></div>
<button id="installBtn">ðŸ“² Install Agrima Mart</button>

<div id="modal"></div>
<div id="cartModal"></div>
<div id="toast"></div>

<script>
const phone="919929333794";
const sheetURL="https://opensheet.elk.sh/1DLJoLnM_GcB_a1uYDOk1YaFX3KTHEXCAF4gxgUXWdE4/Sheet1";

const productsDiv=document.getElementById("products"); // âœ… FIX
const modal=document.getElementById("modal");
const cartModal=document.getElementById("cartModal");

let products=[],cart=JSON.parse(localStorage.getItem("cart"))||{};
let currentCat="All Products",frozen=false,modalOpen=false,cartOpen=false;
let selectedVariant={},backCount=0;

/* FROZEN CART */
const qs=new URLSearchParams(location.search);
if(qs.get("o")){
cart=JSON.parse(LZString.decompressFromEncodedURIComponent(qs.get("o")));
frozen=true;
}

fetch(sheetURL).then(r=>r.json()).then(d=>{
products=d.map(p=>({
name:p.name,
cat:p.category||"Others",
price:+p.offer||+p.mrp,
mrp:+p.mrp,
desc:p.description||"",
imgs:p.images.split("|"),
colors:(p.colors||"").split("|").filter(Boolean),
sizes:(p.sizes||"").split("|").filter(Boolean)
}));
renderCategories();
renderProducts();
if(frozen) setTimeout(openCart,300);
});

search.oninput=()=>renderProducts();

/* SMART SEARCH */
function smartMatch(p){
let keys=search.value.toLowerCase().trim().split(/\s+/);
let text=(p.name+" "+p.cat).toLowerCase();
return keys.every(k=>text.includes(k));
}

/* CATEGORIES */
function renderCategories(){
let cats=["All Products",...new Set(products.map(p=>p.cat))];
categoryBar.innerHTML=cats.map(c=>
`<button class="${c===currentCat?'active':''}"
onclick="currentCat='${c}';renderCategories();renderProducts()">${c}</button>`
).join("");
}

/* PRODUCTS */
function renderProducts(){
productsDiv.innerHTML=products.filter(p=>
(currentCat==="All Products"||p.cat===currentCat)&&smartMatch(p)
).map(p=>{
let qty=Object.keys(cart).filter(k=>k.startsWith(p.name)).reduce((a,k)=>a+cart[k],0);
return `
<div class="product" onclick="openProduct('${p.name}')">
<img src="${p.imgs[0]}">
<h4>${p.name}</h4>
<p class="price">â‚¹${p.price}</p>
<div class="qty" onclick="event.stopPropagation()">
<button onclick="updateCart('${p.name}',-1)">âˆ’</button>
<span>${qty}</span>
<button onclick="updateCart('${p.name}',1)">+</button>
</div>
</div>`;
}).join("");
updateCount();
}

/* PRODUCT MODAL */
function openProduct(name){
let p=products.find(x=>x.name===name);
selectedVariant[name]={};

modal.innerHTML=`
<div class="modalBox">
<button onclick="history.back()">â¬… Back</button>

<div class="gallery">
${p.imgs.map(i=>`<img src="${i}" loading="lazy">`).join("")}
</div>

<h3>${p.name}</h3>
<p class="price">â‚¹${p.price}</p>
<p>${p.desc}</p>

${p.colors.length?`
<div class="colors">
${p.colors.map(c=>`
<div class="color" style="background:${c}"
onclick="selectColor('${name}','${c}',this)"></div>`).join("")}
</div>`:""}

${p.sizes.length?`
<div class="sizes">
${p.sizes.map(s=>`
<div class="size" onclick="selectSize('${name}','${s}',this)">${s}</div>`).join("")}
</div>`:""}

<div class="qty">
<button onclick="updateCart('${name}',-1,true)">âˆ’</button>
<span>${getQty(name)}</span>
<button onclick="updateCart('${name}',1,true)">+</button>
</div>

</div>`;
modal.style.display="block";
modalOpen=true;
history.pushState({}, "");
}

function selectColor(n,c,e){selectedVariant[n].color=c;e.parentNode.querySelectorAll('.color').forEach(x=>x.classList.remove('active'));e.classList.add('active')}
function selectSize(n,s,e){selectedVariant[n].size=s;e.parentNode.querySelectorAll('.size').forEach(x=>x.classList.remove('active'));e.classList.add('active')}

function getQty(n){return Object.keys(cart).filter(k=>k.startsWith(n)).reduce((a,k)=>a+cart[k],0)}

function updateCart(name,v,stay){
if(frozen) return;
let p=products.find(x=>x.name===name);
let key=name;
if(p.colors.length||p.sizes.length){
let sv=selectedVariant[name];
if(p.colors.length&&!sv.color) return alert("Select color");
if(p.sizes.length&&!sv.size) return alert("Select size");
key=`${name} | ${sv.size||""} | ${sv.color||""}`;
}
cart[key]=(cart[key]||0)+v;
if(cart[key]<=0) delete cart[key];
localStorage.setItem("cart",JSON.stringify(cart));
renderProducts();
if(stay) openProduct(name);
if(cartOpen) renderCart();
}

function openCart(){renderCart();cartModal.style.display="block";cartOpen=true;history.pushState({}, "")}

function renderCart(){
let total=0;
cartModal.innerHTML=`
<div class="modalBox">
<button onclick="history.back()">â¬… Back</button>
${Object.keys(cart).map(k=>{
let [n]=k.split(" | ");
let p=products.find(x=>x.name===n);
let t=p.price*cart[k]; total+=t;
return `<div class="cartItem">
<img src="${p.imgs[0]}">
<div><b>${k}</b>
<div class="qty">
<button onclick="updateCart('${n}',-1)">âˆ’</button>
<span>${cart[k]}</span>
<button onclick="updateCart('${n}',1)">+</button>
</div></div>
<b>â‚¹${t}</b>
</div>`;
}).join("")}
<h3>Total â‚¹${total}</h3>
<button onclick="checkout()" style="width:100%;padding:14px;background:#25D366;color:#fff;border:none">Place Order</button>
</div>`;
}

function updateCount(){cartCount.innerText=Object.values(cart).reduce((a,b)=>a+b,0)}

function checkout(){
const comp=LZString.compressToEncodedURIComponent(JSON.stringify(cart));
let msg="Order%0A";
let total=0;
for(let k in cart){
let [n]=k.split(" | ");
let p=products.find(x=>x.name===n);
let t=p.price*cart[k];
total+=t;
msg+=`${k} Ã— ${cart[k]} = â‚¹${t}%0A`;
}
msg+=`%0ATotal â‚¹${total}%0A${location.origin}${location.pathname}?o=${comp}`;
window.open(`https://wa.me/${phone}?text=${msg}`,"_blank");
}

function showToast(t){toast.innerText=t;toast.style.display="block";setTimeout(()=>toast.style.display="none",2000)}

window.onpopstate=()=>{
if(modalOpen){modal.style.display="none";modalOpen=false;return;}
if(cartOpen){cartModal.style.display="none";cartOpen=false;return;}
if(search.value){search.value="";renderProducts();return;}
backCount++;
if(backCount===1){showToast("Press back again to exit");setTimeout(()=>backCount=0,2000)}
else{window.close()}
}

/* INSTALL */
let deferredPrompt;
window.addEventListener("beforeinstallprompt",e=>{
e.preventDefault();deferredPrompt=e;
installBtn.style.display="block";
});
installBtn.onclick=async()=>{
deferredPrompt.prompt();
await deferredPrompt.userChoice;
installBtn.style.display="none";
};
</script>

</body>
</html>
