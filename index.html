<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AGRIMA MART</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#25D366">
<script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#fff}

/* HEADER */
#topHeader{
background:#25D366;color:#fff;
padding:10px 14px;
display:flex;align-items:center;justify-content:space-between;
position:sticky;top:0;z-index:20
}
#topHeader .title{font-size:18px;font-weight:bold}
.headerSocial{display:flex;gap:10px}
.headerSocial img{width:26px;height:26px;border-radius:50%}

/* SEARCH + CATEGORY */
#search{width:94%;margin:10px auto;padding:10px;display:block}
#categoryBar{display:flex;overflow-x:auto;padding:8px;background:#eee}
#categoryBar button{margin-right:8px;border:none;border-radius:20px;padding:8px 14px}
#categoryBar .active{background:#25D366;color:#fff}

/* PRODUCTS */
#products{display:grid;gap:12px;padding:12px}
@media(max-width:600px){#products{grid-template-columns:repeat(2,1fr)}}
@media(min-width:601px){#products{grid-template-columns:repeat(5,1fr)}}

.product{border:1px solid #ddd;border-radius:10px;padding:8px}
.product img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:8px}
.price{color:#2e7d32;font-weight:bold}
del{color:#888;font-size:12px}
.discount{color:red;font-size:12px;margin-left:4px}

/* QTY */
.qty{display:flex;gap:12px;align-items:center;justify-content:center;margin-top:6px}
.qty button{padding:6px 14px;border:none;background:#25D366;color:#fff;border-radius:6px}

/* CART FLOAT */
#cartBtn{
position:fixed;bottom:22px;right:22px;
width:64px;height:64px;border-radius:50%;
background:#25D366;color:#fff;
display:flex;align-items:center;justify-content:center;
font-size:26px;z-index:200
}
#cartCount{
position:absolute;top:-6px;right:-6px;
background:red;color:#fff;border-radius:50%;
padding:4px 8px;font-size:13px
}

/* MODALS */
#modal,#cartModal{
display:none;position:fixed;top:0;left:0;
width:100%;height:100%;
background:rgba(0,0,0,.5);z-index:999
}
.modalBox{background:#fff;height:100%;overflow-y:auto;padding:14px}

/* IMAGE GALLERY (RESTORED) */
.gallery{
display:flex;gap:10px;overflow-x:auto;
scroll-snap-type:x mandatory
}
.gallery img{
width:100%;max-width:420px;
flex-shrink:0;border-radius:10px;
scroll-snap-align:center
}

/* CART ITEMS (RESTORED) */
.cartItem{
display:flex;gap:10px;
border-bottom:1px solid #ddd;
padding:8px 0;align-items:center
}
.cartItem img{
width:50px;height:50px;
object-fit:cover;border-radius:6px
}

/* INSTALL BUTTON */
#installBtn{
position:fixed;bottom:100px;right:22px;
padding:14px 18px;border-radius:30px;
background:#000;color:#fff;border:none;
display:none;z-index:300
}

/* TOAST */
#toast{
position:fixed;bottom:40px;left:50%;
transform:translateX(-50%);
background:#333;color:#fff;
padding:10px 18px;border-radius:20px;
display:none;z-index:9999
}
</style>
</head>

<body>

<header id="topHeader">
  <span class="title">AGRIMA MART</span>
  <div class="headerSocial">
    <a href="https://wa.me/919929333794" target="_blank">
      <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg">
    </a>
    <a href="https://instagram.com/agrima.mart" target="_blank">
      <img src="https://upload.wikimedia.org/wikipedia/commons/a/a5/Instagram_icon.png">
    </a>
    <a href="https://facebook.com/p/Agrima-Mart-61575460105163/" target="_blank">
      <img src="https://upload.wikimedia.org/wikipedia/commons/1/1b/Facebook_icon.svg">
    </a>
  </div>
</header>

<input id="search" placeholder="Search products...">
<div id="categoryBar"></div>
<div id="products"></div>

<div id="cartBtn" onclick="openCart()">ðŸ›’<span id="cartCount">0</span></div>
<button id="installBtn">ðŸ“² Install Agrima Mart</button>

<div id="modal"></div>
<div id="cartModal"></div>
<div id="toast"></div>

<script>
const phone="919929333794";
const sheetURL="https://opensheet.elk.sh/1sGSXFUrgvSXMVvPWvpk2JHBIcl2dRf5LBan_vigLIHE/Sheet1";

let products=[],cart=JSON.parse(localStorage.getItem("cart"))||{};
let currentCat="All Products", frozen=false;
let modalOpen=false, cartOpen=false;
let renderLimit=20;

const productsDiv=document.getElementById("products");
const modal=document.getElementById("modal");
const cartModal=document.getElementById("cartModal");

/* TOAST */
function showToast(msg){
toast.innerText=msg;
toast.style.display="block";
setTimeout(()=>toast.style.display="none",2000);
}

/* INITIAL HISTORY */
history.pushState({home:true},"");

/* FROZEN CART SNAPSHOT */
const qs=new URLSearchParams(location.search);
if(qs.get("o")){
cart=JSON.parse(LZString.decompressFromEncodedURIComponent(qs.get("o")));
frozen=true;
}

/* LOAD PRODUCTS */
fetch(sheetURL).then(r=>r.json()).then(d=>{
products=d.map(p=>({
name:p.name,
cat:p.category||"Others",
price:+p.offer||+p.mrp,
mrp:+p.mrp,
desc:p.description||"",
imgs:p.images.split("|")
}));
restoreState();
renderCategories();
renderProducts();
if(frozen) setTimeout(openCart,300);
});

search.oninput=()=>{renderLimit=20;renderProducts();};

/* CATEGORIES */
function renderCategories(){
let cats=["All Products",...new Set(products.map(p=>p.cat))];
categoryBar.innerHTML=cats.map(c=>
`<button class="${c===currentCat?'active':''}"
onclick="currentCat='${c}';renderLimit=20;renderCategories();renderProducts();history.pushState({},'')">${c}</button>`
).join("");
}

/* PRODUCTS */
function renderProducts(){
let keys=search.value.toLowerCase().trim().split(/\s+/);
let list=products.filter(p=>{
let text=(p.name+" "+p.cat).toLowerCase();
return keys.every(k=>text.includes(k)) &&
(currentCat==="All Products"||p.cat===currentCat);
});

productsDiv.innerHTML=list.slice(0,renderLimit).map(p=>{
let qty=cart[p.name]||0;
let discount=p.mrp>p.price?Math.round(((p.mrp-p.price)/p.mrp)*100):0;
return `
<div class="product" onclick="openProduct('${p.name}')">
<img src="${p.imgs[0]}" loading="lazy">
<h4>${p.name}</h4>
<p class="price">â‚¹${p.price} <del>â‚¹${p.mrp}</del>
${discount?`<span class="discount">${discount}% OFF</span>`:''}</p>
<div class="qty" onclick="event.stopPropagation()">
<button onclick="updateCart('${p.name}',-1)">âˆ’</button>
<span>${qty}</span>
<button onclick="updateCart('${p.name}',1)">+</button>
</div>
</div>`;
}).join("");

updateCount();
}

/* INFINITE SCROLL */
window.addEventListener("scroll",()=>{
if(innerHeight+scrollY>=document.body.offsetHeight-200){
renderLimit+=20;renderProducts();
}
});

/* PRODUCT MODAL */
function openProduct(name){
let p=products.find(x=>x.name===name);
let q=cart[name]||0;
modal.innerHTML=`
<div class="modalBox">
<button onclick="history.back()">â¬… Back</button>
<div class="gallery">
${p.imgs.map(i=>`<img src="${i}" loading="lazy">`).join("")}
</div>
<h3>${p.name}</h3>
<p class="price">â‚¹${p.price} <del>â‚¹${p.mrp}</del></p>
<p>${p.desc}</p>
<div class="qty">
<button onclick="updateCart('${name}',-1,true)">âˆ’</button>
<span>${q}</span>
<button onclick="updateCart('${name}',1,true)">+</button>
</div>
</div>`;
modal.style.display="block";
modalOpen=true;
history.pushState({}, "");
}

/* CART */
function openCart(){
renderCart();
cartModal.style.display="block";
cartOpen=true;
history.pushState({}, "");
}

function renderCart(){
let total=0;
cartModal.innerHTML=`
<div class="modalBox">
<button onclick="history.back()">â¬… Back</button>
<h3>Your Cart</h3>
${Object.keys(cart).map(n=>{
let p=products.find(x=>x.name===n);
let t=p.price*cart[n]; total+=t;
return `
<div class="cartItem">
<img src="${p.imgs[0]}">
<div style="flex:1">
<b>${n}</b><br>â‚¹${p.price} Ã— ${cart[n]}
<div class="qty">
<button onclick="updateCart('${n}',-1)">âˆ’</button>
<span>${cart[n]}</span>
<button onclick="updateCart('${n}',1)">+</button>
</div>
</div>
<b>â‚¹${t}</b>
</div>`;
}).join("")}
<hr>
<h3 style="text-align:right">Total â‚¹${total}</h3>
<button onclick="checkout()" style="width:100%;padding:14px;background:#25D366;color:#fff;border:none;border-radius:6px">
Place Order on WhatsApp
</button>
</div>`;
}

/* CART UPDATE */
function updateCart(n,v,stay){
if(frozen) return;
cart[n]=(cart[n]||0)+v;
if(cart[n]<=0) delete cart[n];
localStorage.setItem("cart",JSON.stringify(cart));
renderProducts();
if(stay) openProduct(n);
if(cartOpen) renderCart();
}

/* COUNT */
function updateCount(){
cartCount.innerText=Object.values(cart).reduce((a,b)=>a+b,0);
}

/* CHECKOUT â€“ CLEAR CART ONLY AFTER WA OPENS ONCE */
function checkout(){
  if(frozen || Object.keys(cart).length === 0) return;

  const compressed = LZString.compressToEncodedURIComponent(JSON.stringify(cart));
  let msg = "Hello Agrima Mart ðŸ‘‹%0A%0AðŸ§¾ Order Details%0A";
  let total = 0;

  for(let n in cart){
    let p = products.find(x => x.name === n);
    let t = p.price * cart[n];
    total += t;
    msg += `â€¢ ${n} Ã— ${cart[n]} = â‚¹${t}%0A`;
  }

  const link = `${location.origin}${location.pathname}?o=${compressed}`;
  msg += `%0AðŸ’° Total: â‚¹${total}%0A%0AðŸ“¦ View Cart:%0A${link}`;

  /* ðŸ” prevent multiple clears */
  if(sessionStorage.getItem("wa_sent")) return;
  sessionStorage.setItem("wa_sent","1");

  /* open WhatsApp */
  window.open(`https://wa.me/${phone}?text=${msg}`,"_blank");

  /* clear cart AFTER WhatsApp opens once */
  setTimeout(()=>{
    cart = {};
    localStorage.removeItem("cart");
    sessionStorage.removeItem("wa_sent");

    cartModal.style.display = "none";
    cartOpen = false;

    updateCount();
    renderProducts();
    showToast("Order sent successfully ðŸ§¾");
  }, 1000);
}

/* BACK BUTTON (FIXED PRIORITY) */
let backCount=0;
window.onpopstate=()=>{
if(modalOpen){modal.style.display="none";modalOpen=false;return;}
if(cartOpen){cartModal.style.display="none";cartOpen=false;return;}
if(search.value!==""){search.value="";renderProducts();return;}
if(currentCat!=="All Products"){
currentCat="All Products";
renderCategories();renderProducts();
return;
}
backCount++;
if(backCount===1){
showToast("Press back again to exit");
setTimeout(()=>backCount=0,2000);
}else{
navigator.app?.exitApp?.()||window.close();
}
};

/* RESUME STATE */
function restoreState(){
let s=JSON.parse(localStorage.getItem("state"));
if(!s) return;
currentCat=s.cat||"All Products";
search.value=s.search||"";
setTimeout(()=>scrollTo(0,s.scroll||0),300);
}
window.addEventListener("beforeunload",()=>{
localStorage.setItem("state",JSON.stringify({
cat:currentCat,
search:search.value,
scroll:scrollY
}));
});

/* INSTALL BUTTON */
let deferredPrompt;
window.addEventListener("beforeinstallprompt",e=>{
e.preventDefault();deferredPrompt=e;
if(!matchMedia('(display-mode: standalone)').matches)
installBtn.style.display="block";
});
installBtn.onclick=async()=>{
deferredPrompt.prompt();
await deferredPrompt.userChoice;
installBtn.style.display="none";
};

/* SERVICE WORKER */
if("serviceWorker" in navigator){
navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
