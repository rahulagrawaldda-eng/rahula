<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Agrima Mart</title>

<style>
body{margin:0;font-family:Arial}
header{background:#25D366;color:#fff;padding:12px;font-size:18px}
#products{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;padding:12px}
.product{border:1px solid #ddd;border-radius:10px;padding:8px;cursor:pointer}
.product img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:8px}
.price{color:#2e7d32;font-weight:bold}

#modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#0008}
.modalBox{background:#fff;height:100%;overflow:auto;padding:14px}

.gallery{display:flex;gap:10px;overflow-x:auto}
.gallery img{width:100%;max-width:420px;border-radius:10px}

.variant{margin:12px 0}
.variantTitle{font-weight:600;margin-bottom:6px}

.sizeBtn{
  padding:6px 12px;border:1px solid #25D366;
  background:#fff;border-radius:6px;margin-right:6px
}
.sizeBtn.active{background:#25D366;color:#fff}
.sizeBtn.disabled{opacity:.4;pointer-events:none}

.colorRow{display:flex;gap:10px}
.colorDot{
  width:26px;height:26px;border-radius:50%;
  border:2px solid #ccc;cursor:pointer
}
.colorDot.active{border:3px solid #25D366}
.colorDot.disabled{opacity:.3;pointer-events:none}
</style>
</head>

<body>

<header>Agrima Mart</header>
<div id="products"></div>
<div id="modal"></div>

<script>
const sheetURL="https://opensheet.elk.sh/1DLJoLnM_GcB_a1uYDOk1YaFX3KTHEXCAF4gxgUXWdE4/Sheet1";
const phone="919929333794";

let products=[];
let selectedSize=null;
let selectedColor=null;
let currentProduct=null;

const productsDiv=document.getElementById("products");
const modal=document.getElementById("modal");

function parseStock(s){
  let m={}; if(!s) return m;
  s.split("|").forEach(x=>{
    let [k,v]=x.split(":");
    m[k]=+v;
  });
  return m;
}

function colorHex(c){
  return {
    blue:"#1e88e5",black:"#000",
    red:"#e53935",green:"#43a047",
    white:"#fff"
  }[c.toLowerCase()] || "#999";
}

fetch(sheetURL).then(r=>r.json()).then(d=>{
products=d.map(p=>({
  name:p.name,
  price:+p.offer||+p.mrp,
  mrp:+p.mrp,
  desc:p.description||"",
  imgs:p.images.split("|"),
  sizes:p.sizes?p.sizes.split("|"):[],
  colors:p.colors?p.colors.split("|"):[],
  stock:p.stock||""
}));
renderProducts();
});

function renderProducts(){
productsDiv.innerHTML=products.map(p=>`
<div class="product" onclick="openProduct('${p.name}')">
<img src="${p.imgs[0]}">
<h4>${p.name}</h4>
<p class="price">₹${p.price}</p>
</div>`).join("");
}

function openProduct(name){
const p=products.find(x=>x.name===name);
currentProduct=name;
selectedSize=null;
selectedColor=null;

const stock=parseStock(p.stock);

let html=`
<div class="modalBox">
<button onclick="modal.style.display='none'">⬅ Back</button>

<div class="gallery">
${p.imgs.map(i=>`<img src="${i}">`).join("")}
</div>

<h3>${p.name}</h3>
<p>${p.desc}</p>
`;

if(p.sizes.length){
html+=`
<div class="variant">
<div class="variantTitle">Size</div>
${p.sizes.map(s=>{
const disabled=p.colors.length
? p.colors.every(c=>(stock[`${s}-${c}`]||0)<=0)
: (stock[s]||0)<=0;
return `<button class="sizeBtn ${disabled?'disabled':''}"
onclick="selectSize('${s}')">${s}</button>`;
}).join("")}
</div>`;
}

if(p.colors.length){
html+=`
<div class="variant">
<div class="variantTitle">Color</div>
<div class="colorRow">
${p.colors.map(c=>{
const disabled=true;
return `<div class="colorDot disabled"
style="background:${colorHex(c)}"
data-color="${c}"
onclick="selectColor('${c}')"></div>`;
}).join("")}
</div>
</div>`;
}

html+=`
<button style="width:100%;padding:14px;background:#25D366;color:#fff;border:none;border-radius:6px"
onclick="addToCart()">Add to Cart</button>
</div>`;

modal.innerHTML=html;
modal.style.display="block";
}

function selectSize(s){
selectedSize=s;
document.querySelectorAll(".sizeBtn").forEach(b=>b.classList.remove("active"));
event.target.classList.add("active");

const p=products.find(x=>x.name===currentProduct);
const stock=parseStock(p.stock);

document.querySelectorAll(".colorDot").forEach(d=>{
const c=d.dataset.color;
const available=(stock[`${s}-${c}`]||0)>0;
d.classList.toggle("disabled",!available);
});
}

function selectColor(c){
if(event.target.classList.contains("disabled")) return;
selectedColor=c;
document.querySelectorAll(".colorDot").forEach(d=>d.classList.remove("active"));
event.target.classList.add("active");
}

function addToCart(){
const p=products.find(x=>x.name===currentProduct);
if(p.sizes.length && !selectedSize){alert("Select size");return;}
if(p.colors.length && !selectedColor){alert("Select color");return;}

const text=`Hello Agrima Mart%0A${p.name} (${selectedSize||""}${selectedColor?", "+selectedColor:""})`;
window.open(`https://wa.me/${phone}?text=${text}`,"_blank");
}
</script>

</body>
</html>
