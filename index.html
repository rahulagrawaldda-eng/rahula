<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AGRIMA MART</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#25D366">
<script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>

<style>
body{margin:0;font-family:Arial}
#topHeader{background:#25D366;color:#fff;padding:10px 14px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:50}
.headerSocial{display:flex;gap:10px}
.headerSocial img{width:26px;height:26px}

#search{width:94%;margin:10px auto;padding:10px}
#categoryBar{display:flex;gap:8px;overflow-x:auto;padding:8px;background:#eee}
#categoryBar button{border:none;border-radius:20px;padding:8px 14px}
#categoryBar .active{background:#25D366;color:#fff}

#products{display:grid;gap:12px;padding:12px}
@media(max-width:600px){#products{grid-template-columns:repeat(2,1fr)}}
@media(min-width:601px){#products{grid-template-columns:repeat(5,1fr)}}

.product{border:1px solid #ddd;border-radius:10px;padding:8px;cursor:pointer}
.product img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:8px}

.mrp{text-decoration:line-through;color:#777;font-size:13px}
.price{color:#2e7d32;font-weight:bold}
.off{color:#d32f2f;font-size:13px}

.qty{display:flex;justify-content:center;gap:12px;margin-top:6px}
.qty button{padding:6px 14px;background:#25D366;color:#fff;border:none;border-radius:6px}

#cartBtn{position:fixed;bottom:22px;right:22px;width:64px;height:64px;border-radius:50%;background:#25D366;color:#fff;font-size:26px;display:flex;align-items:center;justify-content:center;z-index:200}
#cartCount{position:absolute;top:-6px;right:-6px;background:red;color:#fff;border-radius:50%;padding:4px 8px;font-size:13px}

#installBtn{position:fixed;bottom:100px;right:22px;padding:14px 18px;border-radius:30px;background:#000;color:#fff;border:none;display:none;z-index:300}

#modal,#cartModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:999}
.modalBox{background:#fff;height:100%;overflow:auto;padding:14px}

.gallery{display:flex;gap:10px;overflow-x:auto}
.gallery img{width:90vw;max-width:420px;object-fit:contain;background:#f5f5f5;border-radius:10px}

.colors{display:flex;gap:8px;margin:10px 0}
.color{width:24px;height:24px;border-radius:50%;border:2px solid #ccc}
.color.active{border:3px solid #000;box-shadow:0 0 0 3px #25D366;transform:scale(1.15)}

.sizes{display:flex;gap:8px;margin:10px 0;flex-wrap:wrap}
.size{padding:6px 12px;border:1px solid #888;border-radius:6px}
.size.active{background:#25D366;color:#fff;border:none}

.cartItem{display:flex;gap:10px;border-bottom:1px solid #ddd;padding:8px 0;align-items:center}
.cartImg{width:52px;height:52px;object-fit:cover;border-radius:6px;border:1px solid #ddd}

#toast{position:fixed;bottom:40px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:10px 18px;border-radius:20px;display:none}
</style>
</head>

<body>

<header id="topHeader">
<b>AGRIMA MART</b>
<div class="headerSocial">
<a href="https://wa.me/919929333794"><img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg"></a>
<a href="https://instagram.com/agrima.mart"><img src="https://upload.wikimedia.org/wikipedia/commons/a/a5/Instagram_icon.png"></a>
<a href="https://facebook.com/p/Agrima-Mart-61575460105163/"><img src="https://upload.wikimedia.org/wikipedia/commons/1/1b/Facebook_icon.svg"></a>
</div>
</header>

<input id="search" placeholder="Search products...">
<div id="categoryBar"></div>
<div id="products"></div>

<div id="cartBtn" onclick="openCart()">ðŸ›’<span id="cartCount">0</span></div>
<button id="installBtn">ðŸ“² Install Agrima Mart</button>

<div id="modal"></div>
<div id="cartModal"></div>
<div id="toast"></div>

<script>
const phone="919929333794";
const sheetURL="https://opensheet.elk.sh/1DLJoLnM_GcB_a1uYDOk1YaFX3KTHEXCAF4gxgUXWdE4/Sheet1";

const productsDiv=document.getElementById("products");
const installBtn=document.getElementById("installBtn");

let products=[],cart=JSON.parse(localStorage.getItem("cart"))||{};
let currentCat="All Products",selectedVariant={},backCount=0;
let modalOpen=false,cartOpen=false,frozen=false;

/* SNAPSHOT */
const qs=new URLSearchParams(location.search);
if(qs.get("o")){
cart=JSON.parse(LZString.decompressFromEncodedURIComponent(qs.get("o")));
frozen=true;
}

/* INITIAL STATE */
history.replaceState({home:true},"");

/* LOAD */
fetch(sheetURL).then(r=>r.json()).then(d=>{
products=d.map(p=>{
let mrp=+p.mrp;
let price=+p.offer||mrp;
return{
name:p.name,
cat:p.category||"Others",
mrp,price,
off:mrp?Math.round((mrp-price)/mrp*100):0,
desc:p.description||"",
imgs:p.images.split("|"),
colors:(p.colors||"").split("|").filter(Boolean),
sizes:(p.sizes||"").split("|").filter(Boolean)
}});
renderCategories();
renderProducts();
if(frozen) setTimeout(openCart,300);
});

search.oninput=()=>renderProducts();

/* CATEGORY */
function renderCategories(){
let cats=["All Products",...new Set(products.map(p=>p.cat))];
categoryBar.innerHTML=cats.map(c=>`
<button class="${c===currentCat?'active':''}"
onclick="selectCategory('${c}')">${c}</button>`).join("");
}
function selectCategory(c){
currentCat=c;
renderCategories();
renderProducts();
history.pushState({cat:true},"");
}

/* SEARCH */
function match(p){
return search.value.toLowerCase().split(/\s+/)
.every(k=>(p.name+p.cat).toLowerCase().includes(k));
}

/* PRODUCTS */
function renderProducts(){
productsDiv.innerHTML=products
.filter(p=>(currentCat==="All Products"||p.cat===currentCat)&&match(p))
.map(p=>{
let qty=getQty(p.name);
return`
<div class="product" onclick="openProduct('${p.name}')">
<img src="${p.imgs[0]}">
<h4>${p.name}</h4>
<div class="mrp">â‚¹${p.mrp}</div>
<div class="price">â‚¹${p.price} <span class="off">${p.off}% OFF</span></div>
<div class="qty" onclick="event.stopPropagation()">
<button onclick="addFromCard('${p.name}',-1)">âˆ’</button>
<span>${qty}</span>
<button onclick="addFromCard('${p.name}',1)">+</button>
</div>
</div>`;
}).join("");
updateCount();
}

/* PRODUCT MODAL */
function openProduct(name){
selectedVariant[name]={};
let p=products.find(x=>x.name===name);
modal.innerHTML=`
<div class="modalBox">
<button onclick="history.back()">â¬… Back</button>
<div class="gallery">${p.imgs.map(i=>`<img src="${i}">`).join("")}</div>
<h3>${p.name}</h3>
<div class="mrp">â‚¹${p.mrp}</div>
<div class="price">â‚¹${p.price} (${p.off}% OFF)</div>
<p>${p.desc}</p>

${p.colors.length?`
<div class="colors">
${p.colors.map(c=>`
<div class="color" style="background:${c}"
onclick="selectColor('${name}','${c}',this)"></div>`).join("")}
</div>`:""}

${p.sizes.length?`
<div class="sizes">
${p.sizes.map(s=>`
<div class="size" onclick="selectSize('${name}','${s}',this)">${s}</div>`).join("")}
</div>`:""}

<div class="qty">
<button onclick="updateCart('${name}',-1,true)">âˆ’</button>
<span id="modalQty">${getQty(name)}</span>
<button onclick="updateCart('${name}',1,true)">+</button>
</div>
</div>`;
modal.style.display="block";
modalOpen=true;
history.pushState({product:true},"");
}

/* VARIANTS */
function selectColor(n,c,e){
selectedVariant[n].color=c;
e.parentNode.querySelectorAll('.color').forEach(x=>x.classList.remove('active'));
e.classList.add('active');
}
function selectSize(n,s,e){
selectedVariant[n].size=s;
e.parentNode.querySelectorAll('.size').forEach(x=>x.classList.remove('active'));
e.classList.add('active');
}

/* CART HELPERS */
function getQty(name){
return Object.keys(cart).filter(k=>k.startsWith(name))
.reduce((a,k)=>a+cart[k],0);
}

function addFromCard(name,v){
let p=products.find(x=>x.name===name);
if(p.colors.length||p.sizes.length){
alert(p.colors.length?"Select color":"Select size");
return;
}
updateCart(name,v);
}

function updateCart(name,v,fromModal){
if(frozen){alert("This is a shared cart snapshot");return;}
let p=products.find(x=>x.name===name);
let key=name;
if(p.colors.length||p.sizes.length){
let sv=selectedVariant[name];
if(p.colors.length&&!sv?.color) return alert("Select color");
if(p.sizes.length&&!sv?.size) return alert("Select size");
key=`${name} | ${sv.size||""} | ${sv.color||""}`;
}
cart[key]=(cart[key]||0)+v;
if(cart[key]<=0) delete cart[key];
localStorage.setItem("cart",JSON.stringify(cart));
renderProducts();
if(fromModal) document.getElementById("modalQty").innerText=getQty(name);
if(cartOpen) renderCart();
}

/* CART */
function openCart(){
renderCart();
cartModal.style.display="block";
cartOpen=true;
history.pushState({cart:true},"");
}

function renderCart(){
let total=0;
cartModal.innerHTML=`
<div class="modalBox">
<button onclick="history.back()">â¬… Back</button>
${Object.keys(cart).map(k=>{
let [n]=k.split(" | ");
let p=products.find(x=>x.name===n);
let t=p.price*cart[k];
total+=t;
return`
<div class="cartItem">
<img src="${p.imgs[0]}" class="cartImg">
<div style="flex:1">
<b>${k}</b>
<div>${cart[k]} Ã— â‚¹${p.price} = â‚¹${t}</div>
<div class="qty">
<button onclick="updateCartKey('${k}',-1)">âˆ’</button>
<span>${cart[k]}</span>
<button onclick="updateCartKey('${k}',1)">+</button>
</div>
</div>
<b>â‚¹${t}</b>
</div>`;
}).join("")}
<h3>Total â‚¹${total}</h3>
<button onclick="checkout()" style="width:100%;padding:14px;background:#25D366;color:#fff;border:none">Place Order</button>
</div>`;
}

function updateCartKey(k,v){
if(frozen) return;
cart[k]+=v;
if(cart[k]<=0) delete cart[k];
localStorage.setItem("cart",JSON.stringify(cart));
renderCart();
renderProducts();
}

function updateCount(){
cartCount.innerText=Object.values(cart).reduce((a,b)=>a+b,0);
}

/* CHECKOUT */
function checkout(){
let comp=LZString.compressToEncodedURIComponent(JSON.stringify(cart));
let msg="Order%0A";let total=0;
for(let k in cart){
let [n]=k.split(" | ");
let p=products.find(x=>x.name===n);
let t=p.price*cart[k];
total+=t;
msg+=`${k} Ã— ${cart[k]} = â‚¹${t}%0A`;
}
msg+=`%0ATotal â‚¹${total}%0A${location.origin}${location.pathname}?o=${comp}`;
window.open(`https://wa.me/${phone}?text=${msg}`,"_blank");

if(!frozen){
cart={};
localStorage.removeItem("cart");
renderProducts();
}
}

/* BACK */
window.onpopstate=()=>{
if(modalOpen){modal.style.display="none";modalOpen=false;return;}
if(cartOpen){cartModal.style.display="none";cartOpen=false;return;}
if(currentCat!=="All Products"){
currentCat="All Products";
renderCategories();
renderProducts();
return;
}
if(search.value){
search.value="";
renderProducts();
return;
}
backCount++;
if(backCount===1){
toast.innerText="Press back again to exit";
toast.style.display="block";
setTimeout(()=>{toast.style.display="none";backCount=0},2000);
}else window.close();
};

/* INSTALL */
let deferredPrompt;
window.addEventListener("beforeinstallprompt",e=>{
e.preventDefault();
deferredPrompt=e;
installBtn.style.display="block";
});
installBtn.onclick=async()=>{
deferredPrompt.prompt();
await deferredPrompt.userChoice;
installBtn.style.display="none";
};
</script>

</body>
</html>
