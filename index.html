<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Agrima Mart</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#25D366">
<script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#fff}
header{background:#25D366;color:#fff;padding:14px;text-align:center;font-size:18px;position:sticky;top:0;z-index:10}

/* üîç Search + Category */
#filters{
display:flex;
gap:10px;
padding:10px;
position:sticky;
top:56px;
background:#fff;
z-index:9;
}
#filters input,#filters select{
flex:1;
padding:10px;
border:1px solid #ccc;
border-radius:8px;
font-size:14px;
}

#products{display:grid;gap:12px;padding:12px}
@media(max-width:600px){#products{grid-template-columns:repeat(2,1fr)}}
@media(min-width:601px){#products{grid-template-columns:repeat(5,1fr)}}

.product{border:1px solid #ddd;border-radius:10px;padding:8px}
.product img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:8px}

.price{color:#2e7d32;font-weight:bold}
del{color:#888;font-size:12px}

.qty{display:flex;gap:12px;align-items:center;justify-content:center;margin-top:6px}
.qty button{padding:6px 14px;border:none;background:#25D366;color:#fff;border-radius:6px}

#cartBtn{
position:fixed;bottom:22px;right:22px;
width:64px;height:64px;border-radius:50%;
background:#25D366;color:#fff;
display:flex;align-items:center;justify-content:center;
font-size:26px;z-index:200
}
#cartCount{
position:absolute;top:-6px;right:-6px;
background:red;color:#fff;border-radius:50%;
padding:4px 8px;font-size:13px
}

#modal,#cartModal{
display:none;position:fixed;top:0;left:0;
width:100%;height:100%;
background:rgba(0,0,0,.5);z-index:999
}
.modalBox{background:#fff;height:100%;overflow-y:auto;padding:14px}

.cartItem{display:flex;gap:10px;border-bottom:1px solid #ddd;padding:8px 0;align-items:center}
.cartItem img{width:50px;height:50px;object-fit:cover;border-radius:6px}

#installBtn{
position:fixed;bottom:100px;right:22px;
padding:14px 18px;border-radius:30px;
background:#000;color:#fff;border:none;
display:none;z-index:300
}
</style>
</head>

<body>

<header>Agrima Mart</header>

<!-- üîç SEARCH + CATEGORY -->
<div id="filters">
<input type="search" id="search" placeholder="Search products">
<select id="category">
<option value="">All Categories</option>
</select>
</div>

<div id="products"></div>

<div id="cartBtn" onclick="openCart()">üõí<span id="cartCount">0</span></div>
<button id="installBtn">üì≤ Install Agrima Mart</button>

<div id="modal"></div>
<div id="cartModal"></div>

<script>
const phone="919929333794";
const sheetURL="https://opensheet.elk.sh/1DLJoLnM_GcB_a1uYDOk1YaFX3KTHEXCAF4gxgUXWdE4/Sheet1";

let products=[];
let cart=JSON.parse(localStorage.getItem("cart"))||{};
let frozen=false;
let modalOpen=false;
let cartOpen=false;

const productsDiv=document.getElementById("products");
const searchInput=document.getElementById("search");
const categorySelect=document.getElementById("category");
const modal=document.getElementById("modal");
const cartModal=document.getElementById("cartModal");

/* üîí Frozen cart */
const qs=new URLSearchParams(location.search);
if(qs.get("o")){
cart=JSON.parse(LZString.decompressFromEncodedURIComponent(qs.get("o")));
frozen=true;
}

/* Load products */
fetch(sheetURL).then(r=>r.json()).then(d=>{
products=d.map(p=>({
name:p.name,
price:+p.offer||+p.mrp,
mrp:+p.mrp,
category:p.category||"",
desc:p.description||"",
imgs:p.images.split("|")
}));
buildCategories();
renderProducts();
if(frozen) setTimeout(openCart,300);
});

/* Build category list */
function buildCategories(){
const cats=[...new Set(products.map(p=>p.category).filter(Boolean))];
categorySelect.innerHTML='<option value="">All Categories</option>'+
cats.map(c=>`<option>${c}</option>`).join("");
}

/* Render products */
function renderProducts(){
const term=searchInput.value.toLowerCase();
const cat=categorySelect.value;

productsDiv.innerHTML=products.filter(p=>{
return (!term || p.name.toLowerCase().includes(term)) &&
(!cat || p.category===cat);
}).map(p=>{
let q=cart[p.name]||0;
return `
<div class="product" onclick="openProduct('${p.name}')">
<img src="${p.imgs[0]}" loading="lazy">
<h4>${p.name}</h4>
<p class="price">‚Çπ${p.price} <del>‚Çπ${p.mrp}</del></p>
<div class="qty" onclick="event.stopPropagation()">
<button onclick="updateCart('${p.name}',-1)">‚àí</button>
<span>${q}</span>
<button onclick="updateCart('${p.name}',1)">+</button>
</div>
</div>`;
}).join("");
updateCount();
}

/* Search & category listeners */
searchInput.oninput=renderProducts;
categorySelect.onchange=renderProducts;

/* Product, Cart, Checkout logic ‚Äî UNCHANGED */
/* (kept exactly as your working version) */

/* üîô BACK clears search first */
window.onpopstate=()=>{
if(searchInput.value){
searchInput.value="";
renderProducts();
history.pushState({}, "", location.href);
return;
}
if(modalOpen){modal.style.display="none";modalOpen=false;return;}
if(cartOpen){cartModal.style.display="none";cartOpen=false;return;}
};
</script>

</body>
</html>
